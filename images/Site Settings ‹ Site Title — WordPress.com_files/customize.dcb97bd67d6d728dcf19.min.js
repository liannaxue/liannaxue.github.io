webpackJsonp([31],{1429:function(module,exports,__webpack_require__){"use strict";var page=__webpack_require__(40);var controller=__webpack_require__(655),customizeController=__webpack_require__(2535),config=__webpack_require__(10);module.exports=function(){if(config.isEnabled("manage/customize")){page("/customize/:panel([^.]+)?",controller.siteSelection,controller.sites);page("/customize/:panel?/:domain",controller.siteSelection,controller.navigation,customizeController.customize)}}},1508:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _typeof2=__webpack_require__(31);var _typeof3=_interopRequireDefault(_typeof2);exports.fetchThemes=fetchThemes;exports.fetchNextPage=fetchNextPage;exports.query=query;exports.incrementThemesPage=incrementThemesPage;exports.fetchCurrentTheme=fetchCurrentTheme;exports.fetchThemeDetails=fetchThemeDetails;exports.receiveThemeDetails=receiveThemeDetails;exports.receiveThemeDetailsFailure=receiveThemeDetailsFailure;exports.receiveServerError=receiveServerError;exports.receiveThemes=receiveThemes;exports.activate=activate;exports.activated=activated;exports.clearActivated=clearActivated;exports.purchase=purchase;exports.setBackPath=setBackPath;var _page=__webpack_require__(40);var _page2=_interopRequireDefault(_page);var _conforms=__webpack_require__(1637);var _conforms2=_interopRequireDefault(_conforms);var _defer=__webpack_require__(341);var _defer2=_interopRequireDefault(_defer);var _debug=__webpack_require__(4);var _debug2=_interopRequireDefault(_debug);var _property=__webpack_require__(153);var _property2=_interopRequireDefault(_property);var _actionTypes=__webpack_require__(3);var _selectors=__webpack_require__(1539);var _actions=__webpack_require__(250);var _selectors2=__webpack_require__(1600);var _selectors3=__webpack_require__(1577);var _selectors4=__webpack_require__(1601);var _wp=__webpack_require__(22);var _wp2=_interopRequireDefault(_wp);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var debug=(0,_debug2.default)("calypso:themes:actions");function fetchThemes(site){return function(dispatch,getState){var queryParams=(0,_selectors3.getQueryParams)(getState());var startTime=(new Date).getTime();debug("Query params",queryParams);_wp2.default.undocumented().themes(site,queryParams).then(function(themes){var responseTime=(new Date).getTime()-startTime;dispatch(receiveThemes(themes,site,queryParams,responseTime))}).catch(function(error){return receiveServerError(error)})}}function fetchNextPage(site){return function(dispatch){dispatch(incrementThemesPage(site));dispatch(fetchThemes(site))}}function query(params){return{type:_actionTypes.THEMES_QUERY,params:params}}function incrementThemesPage(site){return{type:_actionTypes.THEMES_INCREMENT_PAGE,site:site}}function fetchCurrentTheme(siteId){return function(dispatch){dispatch({type:_actionTypes.THEME_REQUEST_CURRENT,siteId:siteId});_wp2.default.undocumented().activeTheme(siteId).then(function(theme){debug("Received current theme",theme);dispatch({type:_actionTypes.THEME_RECEIVE_CURRENT,siteId:siteId,themeId:theme.id,themeName:theme.name,themeCost:theme.cost})}).catch(function(error){dispatch({type:_actionTypes.THEME_REQUEST_CURRENT_FAILURE,siteId:siteId,error:error})})}}function fetchThemeDetails(id,site){return function(dispatch){_wp2.default.undocumented().themeDetails(id,site).then(function(themeDetails){debug("Received theme details",themeDetails);dispatch(receiveThemeDetails(themeDetails))}).catch(function(error){dispatch(receiveThemeDetailsFailure(id,error))})}}function receiveThemeDetails(theme){return{type:_actionTypes.THEME_DETAILS_RECEIVE,themeId:theme.id,themeName:theme.name,themeAuthor:theme.author,themePrice:theme.price,themeScreenshot:theme.screenshot,themeScreenshots:theme.screenshots,themeDescription:theme.description,themeDescriptionLong:theme.description_long,themeSupportDocumentation:theme.support_documentation||undefined,themeDownload:theme.download_uri||undefined,themeTaxonomies:theme.taxonomies,themeStylesheet:theme.stylesheet,themeDemoUri:theme.demo_uri,themeActive:theme.active,themePurchased:theme.purchased}}function receiveThemeDetailsFailure(id,error){debug("Received error for theme "+id+":",error);return{type:_actionTypes.THEME_DETAILS_RECEIVE_FAILURE,themeId:id,error:error}}function receiveServerError(error){return{type:_actionTypes.THEMES_RECEIVE_SERVER_ERROR,error:error}}var isFirstPageOfSearch=(0,_conforms2.default)({search:function search(a){return undefined!==a},page:function page(a){return a===1}});function receiveThemes(data,site,queryParams,responseTime){return function(dispatch,getState){var themeAction={type:_actionTypes.THEMES_RECEIVE,siteId:site.ID,isJetpack:!!site.jetpack,wasJetpack:(0,_selectors2.isJetpack)(getState()),themes:data.themes,found:data.found,queryParams:queryParams};var trackShowcaseSearch=(0,_actions.recordTracksEvent)("calypso_themeshowcase_search",{search_term:queryParams.search||null,tier:queryParams.tier,response_time_in_ms:responseTime,result_count:data.found,results_first_page:data.themes.map((0,_property2.default)("id"))});var action=isFirstPageOfSearch(queryParams)?(0,_actions.withAnalytics)(trackShowcaseSearch,themeAction):themeAction;dispatch(action)}}function activate(theme,site){var source=arguments.length<=2||arguments[2]===undefined?"unknown":arguments[2];return function(dispatch){dispatch({type:_actionTypes.THEME_ACTIVATE,theme:theme,site:site});_wp2.default.undocumented().activateTheme(theme,site.ID).then(function(){dispatch(activated(theme,site,source))}).catch(function(error){dispatch(receiveServerError(error))})}}function activated(theme,site){var source=arguments.length<=2||arguments[2]===undefined?"unknown":arguments[2];var purchased=arguments.length<=3||arguments[3]===undefined?false:arguments[3];return function(dispatch,getState){var previousTheme=(0,_selectors.getCurrentTheme)(getState(),site.ID);var queryParams=getState().themes.themesList.get("query");if((typeof theme==="undefined"?"undefined":(0,_typeof3.default)(theme))!=="object"){theme=(0,_selectors4.getThemeById)(getState(),theme)}var action={type:_actionTypes.THEME_ACTIVATED,theme:theme,site:site,siteId:site.ID};var trackThemeActivation=(0,_actions.recordTracksEvent)("calypso_themeshowcase_theme_activate",{theme:theme.id,previous_theme:previousTheme.id,source:source,purchased:purchased,search_term:queryParams.get("search")||null});dispatch((0,_actions.withAnalytics)(trackThemeActivation,action))}}function clearActivated(){return{type:_actionTypes.THEME_CLEAR_ACTIVATED}}function purchase(theme,site){var source=arguments.length<=2||arguments[2]===undefined?"unknown":arguments[2];var CartActions=__webpack_require__(646);var themeItem=__webpack_require__(658).themeItem;return function(dispatch){CartActions.addItem(themeItem(theme.id,source));(0,_defer2.default)(function(){(0,_page2.default)("/checkout/"+site.slug);dispatch({type:_actionTypes.THEME_PURCHASE,id:theme.id,site:site})})}}function setBackPath(path){return{type:_actionTypes.THEME_BACK_PATH_SET,path:path}}},1539:function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.getCurrentTheme=getCurrentTheme;exports.isActivating=isActivating;exports.hasActivated=hasActivated;exports.isRequestingCurrentTheme=isRequestingCurrentTheme;function getCurrentTheme(state,siteId){return state.themes.currentTheme.get("currentThemes").get(siteId)}function isActivating(state){return state.themes.currentTheme.get("isActivating")}function hasActivated(state){return state.themes.currentTheme.get("hasActivated")}function isRequestingCurrentTheme(state,siteId){return!!state.themes.currentTheme.get("requesting").get(siteId)}},1577:function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.isFetchingNextPage=isFetchingNextPage;exports.isLastPage=isLastPage;exports.getThemesList=getThemesList;exports.getQueryParams=getQueryParams;exports.isFetchError=isFetchError;function isFetchingNextPage(state){return state.themes.themesList.getIn(["queryState","isFetchingNextPage"])}function isLastPage(state){return state.themes.themesList.getIn(["queryState","isLastPage"])}function getThemesList(state){return state.themes.themesList.get("list")}function getQueryParams(state){return state.themes.themesList.get("query").toObject()}function isFetchError(state){return state.themes.themesList.getIn(["queryState","error"])}},1600:function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.isJetpack=isJetpack;exports.getParams=getParams;exports.hasSiteChanged=hasSiteChanged;exports.hasParams=hasParams;function isJetpack(state){return!!state.themes.themesLastQuery.get("isJetpack")}function getParams(state){return state.themes.themesLastQuery.get("lastParams")||{}}function hasSiteChanged(state){return state.themes.themesLastQuery.get("previousSiteId")!==state.themes.themesLastQuery.get("currentSiteId")}function hasParams(state){return!!state.themes.themesLastQuery.get("lastParams")}},1601:function(module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.getThemes=getThemes;exports.getThemeById=getThemeById;function getThemes(state){return state.themes.themes.get("themes").toJS()}function getThemeById(state,id){var theme=state.themes.themes.getIn(["themes",id]);return theme?theme.toJS():undefined}},1636:function(module,exports,__webpack_require__){var keys=__webpack_require__(94);function baseConforms(source){var props=keys(source),length=props.length;return function(object){if(object==null){return!length}var index=length;while(index--){var key=props[index],predicate=source[key],value=object[key];if(value===undefined&&!(key in Object(object))||!predicate(value)){return false}}return true}}module.exports=baseConforms},1637:function(module,exports,__webpack_require__){var baseClone=__webpack_require__(126),baseConforms=__webpack_require__(1636);function conforms(source){return baseConforms(baseClone(source,true))}module.exports=conforms},2534:function(module,exports,__webpack_require__){"use strict";var _defer=__webpack_require__(341);var _defer2=_interopRequireDefault(_defer);var _dispatcher=__webpack_require__(38);var _dispatcher2=_interopRequireDefault(_dispatcher);var _page=__webpack_require__(40);var _page2=_interopRequireDefault(_page);var _cart=__webpack_require__(394);var _helpers=__webpack_require__(348);var _cartItems=__webpack_require__(658);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var CustomizeActions={purchase:function purchase(id,site){(0,_cart.addItem)((0,_cartItems.themeItem)(id,"customizer"));(0,_helpers.trackClick)("customizer","purchase");(0,_defer2.default)(function(){(0,_page2.default)("/checkout/"+site.slug);_dispatcher2.default.handleViewAction({type:"THEME_PURCHASE_WITH_CUSTOMIZER",id:id,site:site})})},activated:function activated(id,site,themeActivated){(0,_helpers.trackClick)("customizer","activate");(0,_page2.default)("/design/"+site.slug);themeActivated(id,site,"customizer");_dispatcher2.default.handleViewAction({type:"THEME_ACTIVATED_WITH_CUSTOMIZER",id:id,site:site})},close:function close(previousPath){if(previousPath.indexOf("/design")>-1){(0,_helpers.trackClick)("customizer","close")}_dispatcher2.default.handleViewAction({type:"CLOSED_CUSTOMIZER",previousPath:previousPath})}};module.exports=CustomizeActions},2535:function(module,exports,__webpack_require__){"use strict";var i18n=__webpack_require__(13),ReactDom=__webpack_require__(43),React=__webpack_require__(1),ReduxProvider=__webpack_require__(21).Provider;var sites=__webpack_require__(55)(),route=__webpack_require__(122),analytics=__webpack_require__(16),setTitle=__webpack_require__(648).setDocumentHeadTitle;module.exports={customize:function customize(context){var CustomizeComponent=__webpack_require__(2537),basePath=route.sectionify(context.path);analytics.pageView.record(basePath,"Customizer");context.store.dispatch(setTitle(i18n.translate("Customizer",{textOnly:true})));ReactDom.render(React.createElement(ReduxProvider,{store:context.store},React.createElement(CustomizeComponent,{domain:context.params.domain||"",sites:sites,prevPath:context.prevPath||"",query:context.query,panel:context.params.panel})),document.getElementById("primary"))}}},2536:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _react=__webpack_require__(1);var _react2=_interopRequireDefault(_react);var _classnames=__webpack_require__(11);var _classnames2=_interopRequireDefault(_classnames);var _spinner=__webpack_require__(350);var _spinner2=_interopRequireDefault(_spinner);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}exports.default=_react2.default.createClass({displayName:"CustomizerLoadingPanel",propTypes:{isLoaded:_react2.default.PropTypes.bool},getDefaultProps:function getDefaultProps(){return{isLoaded:false}},render:function render(){var noticeClassNames=(0,_classnames2.default)("customizer-loading-panel__notice",{"is-iframe-loaded":this.props.isLoaded});return _react2.default.createElement("div",{className:noticeClassNames},_react2.default.createElement("div",{className:"customizer-loading-panel__notice-label"},_react2.default.createElement(_spinner2.default,null),this.translate("Loading the Customizerâ€¦")))}});module.exports=exports["default"]},2537:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var React=__webpack_require__(1),url=__webpack_require__(62),Qs=__webpack_require__(193),cloneDeep=__webpack_require__(160),bindActionCreators=__webpack_require__(6).bindActionCreators,connect=__webpack_require__(21).connect,debug=__webpack_require__(4)("calypso:my-sites:customize");var notices=__webpack_require__(71),page=__webpack_require__(40),CustomizerLoadingPanel=__webpack_require__(2536),EmptyContent=__webpack_require__(185),SidebarNavigation=__webpack_require__(1465),Actions=__webpack_require__(2534),themeActivated=__webpack_require__(1508).activated;var loadingTimer;var Customize=React.createClass({displayName:"Customize",propTypes:{domain:React.PropTypes.string.isRequired,sites:React.PropTypes.object.isRequired,prevPath:React.PropTypes.string,query:React.PropTypes.object,themeActivated:React.PropTypes.func.isRequired,panel:React.PropTypes.string},getDefaultProps:function getDefaultProps(){return{domain:"",prevPath:null}},getInitialState:function getInitialState(){return{isWaitingForSiteData:true,iframeLoaded:false,errorFromIframe:false,timeoutError:false}},componentWillMount:function componentWillMount(){this.props.sites.on("change",this.sitesDidUpdate);this.listenToCustomizer();this.waitForLoading();this.sitesDidUpdate();window.scrollTo(0,0)},componentWillUnmount:function componentWillUnmount(){this.props.sites.off("change",this.sitesDidUpdate);window.removeEventListener("message",this.onMessage,false);this.cancelWaitingTimer()},sitesDidUpdate:function sitesDidUpdate(){if(this.props.sites.fetched===true){this.props.sites.off("change",this.sitesDidUpdate);this.setState({isWaitingForSiteData:false})}},getSite:function getSite(){return this.props.sites.getSite(this.props.domain)},canUserCustomizeDomain:function canUserCustomizeDomain(){var site=this.getSite();if(!site){debug("domain is not in the user's site list",this.props.domain);return false}if(site.capabilities&&site.capabilities.edit_theme_options){return true}debug("user cannot customize domain",this.props.domain);return false},getPreviousPath:function getPreviousPath(){var path=this.props.prevPath;if(!path||/^\/customize\/?/.test(path)){path="/stats";if(this.props.domain){path+="/"+this.props.domain}}return path},goBack:function goBack(){var path=this.getPreviousPath();Actions.close(path);debug("returning to previous page",path);page.back(path)},waitForLoading:function waitForLoading(){debug("waiting for iframe to load");this.cancelWaitingTimer();loadingTimer=setTimeout(this.cancelCustomizer,25e3)},cancelWaitingTimer:function cancelWaitingTimer(){if(loadingTimer){clearTimeout(loadingTimer)}},cancelCustomizer:function cancelCustomizer(){if(this.state.iframeLoaded){return}debug("iframe loading timed out");this.setState({timeoutError:true})},getUrl:function getUrl(){var site=this.getSite();if(!site){return false}var domain="//"+site.domain;if(site.options&&site.options.unmapped_url){domain=site.options.unmapped_url}if(site.options&&site.options.admin_url){return site.options.admin_url+"customize.php?"+this.buildCustomizerQuery()}return domain+"/wp-admin/customize.php?"+this.buildCustomizerQuery()},buildCustomizerQuery:function buildCustomizerQuery(){var _window$location=window.location;var protocol=_window$location.protocol;var host=_window$location.host;var query=cloneDeep(this.props.query);var site=this.getSite();var panel=this.props.panel;query.return=protocol+"//"+host+this.getPreviousPath();query.calypso=true;query.calypsoOrigin=protocol+"//"+host;if(site.options&&site.options.frame_nonce){query["frame-nonce"]=site.options.frame_nonce}var panels={widgets:{panel:"widgets"},fonts:{section:"jetpack_fonts"},identity:{section:"title_tagline"},"custom-css":{section:"jetpack_custom_css"}};if(panels.hasOwnProperty(panel)){query.autofocus=panels[panel]}return Qs.stringify(query)},listenToCustomizer:function listenToCustomizer(){window.removeEventListener("message",this.onMessage,false);window.addEventListener("message",this.onMessage,false)},onMessage:function onMessage(event){var message,themeSlug,parsedOrigin,parsedSite,site=this.getSite();if(!site||!site.options){debug("ignoring message received from iframe because the site data cannot be found");return}parsedOrigin=url.parse(event.origin,true);parsedSite=url.parse(site.options.unmapped_url);if(parsedOrigin.hostname!==this.props.domain&&parsedOrigin.hostname!==parsedSite.hostname){debug("ignoring message received from iframe with incorrect origin",event.origin);return}if(typeof event.data!=="string"||event.data[0]!=="{"){debug("ignoring message received from iframe with bad data",event.data);return}message=JSON.parse(event.data);if(message.calypso&&message.command){switch(message.command){case"back":debug("iframe says it is done",message);if(message.error){this.setState({errorFromIframe:message.error});return}if(message.warning){notices.warning(message.warning,{displayOnNextPage:true})}if(message.info){notices.info(message.info,{displayOnNextPage:true})}if(message.success){notices.success(message.success,{displayOnNextPage:true})}this.goBack();break;case"loading":debug("iframe says it is starting loading customizer");this.cancelWaitingTimer();break;case"loaded":debug("iframe says it is finished loading customizer");this.cancelWaitingTimer();this.setState({iframeLoaded:true});break;case"activated":themeSlug=message.theme.stylesheet.split("/")[1];Actions.activated(themeSlug,site,this.props.themeActivated);break;case"purchased":themeSlug=message.theme.stylesheet.split("/")[1];Actions.purchase(themeSlug,site);break}}},renderErrorPage:function renderErrorPage(error){return React.createElement("div",{className:"main main-column customize",role:"main"},React.createElement(SidebarNavigation,null),React.createElement(EmptyContent,{title:error.title,line:error.line,action:error.action,actionURL:error.actionURL,actionCallback:error.actionCallback}))},render:function render(){var iframeUrl;if(this.state.timeoutError){this.cancelWaitingTimer();return this.renderErrorPage({title:this.translate("Sorry, the customizing tools did not load correctly"),action:this.translate("Try again"),actionCallback:function actionCallback(){window.location.reload()}})}if(this.state.errorFromIframe){this.cancelWaitingTimer();return this.renderErrorPage({title:this.state.errorFromIframe})}if(this.props.sites.fetched!==true){return React.createElement("div",{className:"main main-column customize is-iframe",role:"main"},React.createElement(CustomizerLoadingPanel,null))}if(!this.canUserCustomizeDomain()){this.cancelWaitingTimer();return this.renderErrorPage({title:this.translate("Sorry, you do not have enough permissions to customize this site")})}iframeUrl=this.getUrl();if(iframeUrl){debug("loading iframe URL",iframeUrl);var iframeClassName=this.state.iframeLoaded?"is-iframe-loaded":"";return React.createElement("div",{className:"main main-column customize is-iframe",role:"main"},React.createElement(CustomizerLoadingPanel,{isLoaded:this.state.iframeLoaded}),React.createElement("iframe",{className:iframeClassName,src:iframeUrl}))}this.cancelWaitingTimer();return this.renderErrorPage({title:this.translate("Sorry, the customizing tools did not load correctly"),action:this.translate("Try again"),actionCallback:function actionCallback(){window.location.reload()}})}});exports.default=connect(function(state,props){return props},bindActionCreators.bind(null,{themeActivated:themeActivated}))(Customize);module.exports=exports["default"]}});